{% extends 'users/base.html' %}
{% load static %}

{% block title %}Заучивание - {{ module.name }}{% endblock %}

{% block content %}
<div class="learn-container">
    <div class="learn-header">
        <div class="back-button">
            <a href="{% url 'cards:module' module.id %}" class="back-link">
                <i class="bi bi-arrow-left"></i>
                <span>Назад к модулю</span>
            </a>
        </div>
        <div class="module-info">
            <h1>{{ module.name }}</h1>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="currentCard">0</span> из <span id="totalCards">{{ total_cards }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="round-info">
        <div class="round-badge" id="roundBadge">Раунд 1</div>
        <div class="round-description" id="roundDescription">
            <div class="description-icon">
                <i class="bi bi-lightbulb"></i>
            </div>
            <div class="description-text">
                <h3>Выберите правильный перевод термина</h3>
                <p>Внимательно прочитайте термин и выберите его точный перевод из предложенных вариантов</p>
            </div>
        </div>
    </div>

    <div class="card-container">
        <div class="card" id="currentCard">
            <div class="card-term" id="cardTerm"></div>
            <div class="card-options" id="cardOptions"></div>
            <div class="card-input" id="cardInput" style="display: none;">
                <input type="text" id="translationInput" placeholder="Введите перевод...">
                <button class="check-btn" onclick="checkTranslation()">Проверить</button>
            </div>
        </div>
    </div>

    <div class="navigation-buttons">
        <button class="nav-btn" id="nextBtn" onclick="nextCard()">
            Далее
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

<!-- Уведомления -->
<div class="notification-container" id="notificationContainer"></div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
.learn-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f8f5ff;
    min-height: 100vh;
    padding: 20px;
}

.learn-header {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
}

.back-button {
    margin-bottom: 16px;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #666;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.3s ease;
}

.back-link:hover {
    color: #7c4dff;
}

.module-info h1 {
    margin: 0 0 16px 0;
    color: #333;
    font-size: 1.8rem;
}

.progress-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.progress-bar {
    height: 8px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background: #7c4dff;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.9rem;
    color: #666;
    text-align: right;
}

.round-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.round-badge {
    background: #7c4dff;
    color: white;
    padding: 8px 24px;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(124, 77, 255, 0.2);
}

.round-description {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    width: 100%;
    max-width: 800px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.description-icon {
    background: #f0e6ff;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.description-icon i {
    font-size: 24px;
    color: #7c4dff;
}

.description-text h3 {
    margin: 0 0 8px 0;
    color: #333;
    font-size: 1.2rem;
}

.description-text p {
    margin: 0;
    color: #666;
    font-size: 1rem;
    line-height: 1.5;
}

.card-container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
}

.card {
    background: white;
    border-radius: 16px;
    padding: 30px;
    width: 100%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.card-term {
    font-size: 2rem;
    font-weight: 500;
    color: #333;
    text-align: center;
}

.card-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.option-btn {
    background: white;
    border: 2px solid #e0e0e0;
    padding: 16px;
    border-radius: 12px;
    font-size: 1rem;
    color: #333;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-btn:hover {
    border-color: #7c4dff;
    transform: translateY(-2px);
}

.option-btn.correct {
    background: #4caf50;
    border-color: #4caf50;
    color: white;
}

.option-btn.incorrect {
    background: #f44336;
    border-color: #f44336;
    color: white;
}

.card-input {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#translationInput {
    width: 100%;
    padding: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

#translationInput:focus {
    border-color: #7c4dff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
}

.check-btn {
    background: #7c4dff;
    color: white;
    border: none;
    padding: 16px;
    border-radius: 12px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.check-btn:hover {
    background: #651fff;
    transform: translateY(-2px);
}

.navigation-buttons {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 20px;
}

.nav-btn {
    background: white;
    border: 2px solid #7c4dff;
    color: #7c4dff;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    min-width: 120px;
    justify-content: center;
}

.nav-btn:hover:not(:disabled) {
    background: #7c4dff;
    color: white;
    transform: translateY(-2px);
}

.nav-btn:disabled {
    border-color: #e0e0e0;
    color: #999;
    cursor: not-allowed;
}

/* Стили для уведомлений */
.notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px 24px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
    max-width: 300px;
}

.notification.success {
    border-left: 4px solid #4caf50;
}

.notification.error {
    border-left: 4px solid #f44336;
}

.notification-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.notification.success .notification-icon {
    background: #e8f5e9;
    color: #4caf50;
}

.notification.error .notification-icon {
    background: #ffebee;
    color: #f44336;
}

.notification-text {
    flex: 1;
    font-size: 0.9rem;
    color: #333;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Отладочная функция
function debug(message, data = null) {
    console.log(`[DEBUG] ${message}`, data || '');
}

let currentRound = 1;
let currentCardIndex = 0;
let cards = {{ cards|safe }};
let totalCards = cards.length;
let currentAnswers = [];
let incorrectCards = [];
let isReviewMode = false;

debug('Initial state:', {
    cards,
    totalCards,
    currentRound,
    currentCardIndex
});

function updateProgress() {
    const progress = (currentCardIndex / (isReviewMode ? incorrectCards.length : totalCards)) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
    document.getElementById('currentCard').textContent = currentCardIndex + 1;
    document.getElementById('totalCards').textContent = isReviewMode ? incorrectCards.length : totalCards;
}

function updateRoundInfo() {
    const roundBadge = document.getElementById('roundBadge');
    const roundDescription = document.getElementById('roundDescription');
    
    if (isReviewMode) {
        roundBadge.textContent = 'Повторение';
        roundDescription.innerHTML = `
            <div class="description-icon">
                <i class="bi bi-arrow-repeat"></i>
            </div>
            <div class="description-text">
                <h3>Повторите слова, на которые вы ответили неправильно</h3>
                <p>Внимательно прочитайте каждый термин и выберите правильный ответ. Это поможет лучше запомнить материал.</p>
            </div>
        `;
        return;
    }
    
    switch(currentRound) {
        case 1:
            roundBadge.textContent = 'Раунд 1';
            roundDescription.innerHTML = `
                <div class="description-icon">
                    <i class="bi bi-translate"></i>
                </div>
                <div class="description-text">
                    <h3>Выберите правильный перевод термина</h3>
                    <p>Внимательно прочитайте термин на английском и выберите его точный перевод на русский язык</p>
                </div>
            `;
            break;
        case 2:
            roundBadge.textContent = 'Раунд 2';
            roundDescription.innerHTML = `
                <div class="description-icon">
                    <i class="bi bi-arrow-left-right"></i>
                </div>
                <div class="description-text">
                    <h3>Выберите правильный термин</h3>
                    <p>Прочитайте перевод на русском и выберите соответствующий термин на английском языке</p>
                </div>
            `;
            break;
        case 3:
            roundBadge.textContent = 'Раунд 3';
            roundDescription.innerHTML = `
                <div class="description-icon">
                    <i class="bi bi-pencil"></i>
                </div>
                <div class="description-text">
                    <h3>Введите термин</h3>
                    <p>Напишите точный термин на английском языке. Обратите внимание на правильное написание</p>
                </div>
            `;
            break;
        case 4:
            roundBadge.textContent = 'Раунд 4';
            roundDescription.innerHTML = `
                <div class="description-icon">
                    <i class="bi bi-pencil"></i>
                </div>
                <div class="description-text">
                    <h3>Введите перевод термина</h3>
                    <p>Напишите точный перевод термина на русский язык. Обратите внимание на правильное написание</p>
                </div>
            `;
            break;
    }
}

function getRandomOptions(correctAnswer, isRound2 = false) {
    debug('Getting random options for:', correctAnswer);
    let options = [correctAnswer];
    let availableCards = cards.filter(card => {
        const compareValue = isRound2 ? card.term : card.translation;
        return compareValue !== correctAnswer;
    });
    
    while (options.length < 4 && availableCards.length > 0) {
        const randomIndex = Math.floor(Math.random() * availableCards.length);
        const randomCard = availableCards[randomIndex];
        const optionValue = isRound2 ? randomCard.term : randomCard.translation;
        options.push(optionValue);
        availableCards.splice(randomIndex, 1);
    }
    
    const shuffledOptions = options.sort(() => Math.random() - 0.5);
    debug('Generated options:', shuffledOptions);
    return shuffledOptions;
}

function getCurrentCard() {
    const card = isReviewMode ? incorrectCards[currentCardIndex] : cards[currentCardIndex];
    debug('Getting current card:', card);
    return card;
}

function displayCard() {
    debug('Displaying card at index:', currentCardIndex);
    const card = getCurrentCard();
    const cardTerm = document.getElementById('cardTerm');
    const cardOptions = document.getElementById('cardOptions');
    const cardInput = document.getElementById('cardInput');
    
    if (currentRound === 3) {
        cardTerm.textContent = card.translation; // Показываем русское слово
        cardOptions.style.display = 'none';
        cardInput.style.display = 'flex';
        document.getElementById('translationInput').value = '';
        document.querySelector('.check-btn').disabled = false;
        document.querySelector('.check-btn').style.backgroundColor = '#7c4dff';
    } else if (currentRound === 4) {
        cardTerm.textContent = card.term; // Показываем английское слово
        cardOptions.style.display = 'none';
        cardInput.style.display = 'flex';
        document.getElementById('translationInput').value = '';
        document.querySelector('.check-btn').disabled = false;
        document.querySelector('.check-btn').style.backgroundColor = '#7c4dff';
    } else {
        cardTerm.textContent = currentRound === 2 ? card.translation : card.term;
        cardOptions.style.display = 'grid';
        cardInput.style.display = 'none';
        
        const correctAnswer = currentRound === 2 ? card.term : card.translation;
        const options = getRandomOptions(correctAnswer, currentRound === 2);
        
        const optionsHtml = options.map(option => `
            <button class="option-btn" data-answer="${option.replace(/"/g, '&quot;')}">
                ${option}
            </button>
        `).join('');
        
        cardOptions.innerHTML = optionsHtml;
        
        document.querySelectorAll('.option-btn').forEach(button => {
            button.addEventListener('click', function() {
                const answer = this.getAttribute('data-answer');
                debug('Button clicked with answer:', answer);
                checkAnswer(answer);
            });
        });
    }
    
    updateProgress();
    updateRoundInfo();
    updateNavigationButtons();
}

function checkAnswer(answer) {
    debug('Checking answer:', answer);
    
    const card = getCurrentCard();
    const correctAnswer = currentRound === 2 ? card.term : card.translation;
    debug('Correct answer:', correctAnswer);
    
    const buttons = document.querySelectorAll('.option-btn');
    
    buttons.forEach(button => {
        button.disabled = true;
        const buttonAnswer = button.getAttribute('data-answer');
        if (buttonAnswer === correctAnswer) {
            button.classList.add('correct');
        } else if (buttonAnswer === answer && answer !== correctAnswer) {
            button.classList.add('incorrect');
        }
    });
    
    const isCorrect = answer === correctAnswer;
    debug('Is correct:', isCorrect);
    
    try {
        const response = fetch('{% url "cards:update_learning_progress" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                card_id: card.id,
                module_id: {{ module.id }},
                is_correct: isCorrect
            })
        });
        
        if (isCorrect) {
            showNotification('Правильно! Продолжайте в том же духе!');
        } else {
            showNotification(`Неправильно. Правильный ответ: ${correctAnswer}`, 'error');
        }
    } catch (error) {
        console.error('Error updating progress:', error);
    }
    
    if (!isCorrect && !isReviewMode) {
        incorrectCards.push(card);
    }
    
    currentAnswers[currentCardIndex] = isCorrect;
    document.getElementById('nextBtn').disabled = false;
}

// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function checkTranslation() {
    const card = getCurrentCard();
    const userInput = document.getElementById('translationInput').value.trim().toLowerCase();
    let correctAnswer;
    
    if (currentRound === 3) {
        correctAnswer = card.term.toLowerCase(); // В раунде 3 проверяем английский термин
    } else if (currentRound === 4) {
        correctAnswer = card.translation.toLowerCase(); // В раунде 4 проверяем русский перевод
    }
    
    const isCorrect = userInput === correctAnswer;
    
    try {
        const response = await fetch('{% url "cards:update_learning_progress" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                card_id: card.id,
                module_id: {{ module.id }},
                is_correct: isCorrect
            })
        });
        
        if (isCorrect) {
            showNotification('Правильно! Продолжайте в том же духе!');
        } else {
            showNotification(`Неправильно. Правильный ответ: ${correctAnswer}`, 'error');
        }
    } catch (error) {
        console.error('Error updating progress:', error);
    }
    
    if (!isCorrect && !isReviewMode) {
        incorrectCards.push(card);
    }
    
    currentAnswers[currentCardIndex] = isCorrect;
    document.getElementById('nextBtn').disabled = false;
    document.querySelector('.check-btn').disabled = true;
    document.querySelector('.check-btn').style.backgroundColor = '#ccc';
}

function startReviewMode() {
    if (incorrectCards.length === 0) {
        return false;
    }
    
    isReviewMode = true;
    currentCardIndex = 0;
    currentAnswers = new Array(incorrectCards.length).fill(false);
    return true;
}

function nextCard() {
    currentCardIndex++;
    debug('Moving to next card:', currentCardIndex);
    
    if (isReviewMode) {
        if (currentCardIndex >= incorrectCards.length) {
            if (currentAnswers.every(answer => answer)) {
                isReviewMode = false;
                incorrectCards = [];
                if (currentRound < 4) {
                    currentRound++;
                    currentCardIndex = 0;
                    currentAnswers = new Array(totalCards).fill(false);
                } else {
                    showCompletionMessage();
                    return;
                }
            } else {
                currentCardIndex = 0;
                currentAnswers = new Array(incorrectCards.length).fill(false);
            }
        }
    } else {
        if (currentCardIndex >= totalCards) {
            if (startReviewMode()) {
                currentCardIndex = 0;
            } else if (currentRound < 4) {
                currentRound++;
                currentCardIndex = 0;
                currentAnswers = new Array(totalCards).fill(false);
            } else {
                showCompletionMessage();
                return;
            }
        }
    }
    
    displayCard();
}

function updateNavigationButtons() {
    document.getElementById('nextBtn').disabled = !currentAnswers[currentCardIndex];
}

// Добавляем функцию для показа уведомлений
function showNotification(message, type = 'success') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = type === 'success' ? 'check-circle' : 'x-circle';
    
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="bi bi-${icon}"></i>
        </div>
        <div class="notification-text">${message}</div>
    `;
    
    container.appendChild(notification);
    
    // Удаляем уведомление через 3 секунды
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showCompletionMessage() {
    // Очищаем информацию о раунде
    document.getElementById('roundBadge').style.display = 'none';
    document.getElementById('roundDescription').style.display = 'none';
    
    // Показываем сообщение о завершении
    const cardContainer = document.querySelector('.card-container');
    cardContainer.innerHTML = `
        <div class="completion-message">
            <div class="completion-icon">
                <i class="bi bi-arrow-repeat"></i>
            </div>
            <h2>Поздравляем!</h2>
            <p>Вы завершили все раунды обучения.</p>
            <button class="restart-btn" onclick="restartLearning()">
                Пройти еще раз
            </button>
        </div>
    `;
    
    // Скрываем кнопки навигации
    document.querySelector('.navigation-buttons').style.display = 'none';
}

function restartLearning() {
    // Сбрасываем все переменные
    currentRound = 1;
    currentCardIndex = 0;
    currentAnswers = new Array(totalCards).fill(false);
    incorrectCards = [];
    isReviewMode = false;
    
    // Показываем информацию о раунде
    document.getElementById('roundBadge').style.display = 'block';
    document.getElementById('roundDescription').style.display = 'block';
    
    // Показываем кнопки навигации
    document.querySelector('.navigation-buttons').style.display = 'flex';
    
    // Очищаем контейнер карточки и показываем первую карточку
    const cardContainer = document.querySelector('.card-container');
    cardContainer.innerHTML = `
        <div class="card" id="currentCard">
            <div class="card-term" id="cardTerm"></div>
            <div class="card-options" id="cardOptions"></div>
            <div class="card-input" id="cardInput" style="display: none;">
                <input type="text" id="translationInput" placeholder="Введите перевод...">
                <button class="check-btn" onclick="checkTranslation()">Проверить</button>
            </div>
        </div>
    `;
    
    // Отображаем первую карточку
    displayCard();
}

// Добавляем стили для сообщения о завершении
const style = document.createElement('style');
style.textContent = `
    .completion-message {
        background: white;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    .completion-icon {
        background: #f0e6ff;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }
    
    .completion-icon i {
        font-size: 40px;
        color: #7c4dff;
    }
    
    .completion-message h2 {
        color: #333;
        margin: 0 0 10px;
    }
    
    .completion-message p {
        color: #666;
        margin: 0 0 20px;
    }
    
    .restart-btn {
        background: #7c4dff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .restart-btn:hover {
        background: #651fff;
        transform: translateY(-2px);
    }
`;
document.head.appendChild(style);

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    debug('Page loaded, initializing...');
    displayCard();
});
</script>
{% endblock %} 