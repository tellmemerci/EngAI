{% extends 'users/base.html' %}
{% load static %}

{% block title %}{{ folder.name }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="folder-container">
    <div class="breadcrumbs">
        <a href="{% url 'cards:cards' %}" class="breadcrumb-item">
            <i class="bi bi-house"></i>
            <span>Главная</span>
        </a>
        {% for crumb in breadcrumbs %}
            {% if not forloop.last %}
                <span class="breadcrumb-separator">/</span>
                <a href="{% url 'cards:folder' crumb.id %}" class="breadcrumb-item">{{ crumb.name }}</a>
            {% else %}
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item current">{{ crumb.name }}</span>
            {% endif %}
        {% endfor %}
    </div>

    <div class="folder-header">
        <div class="header-content">
            <h1>{{ folder.name }}</h1>
        </div>
        <div class="header-actions">
            <div class="action-buttons">
                <button class="action-btn" onclick="editFolder({{ folder.id }}, '{{ folder.name }}')">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="action-btn" onclick="deleteFolder({{ folder.id }})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <button class="create-btn" onclick="showCreateFolderModal()">
                <i class="bi bi-folder-plus"></i>
                <span>Создать папку</span>
            </button>
            <button class="create-btn" onclick="showAddModuleModal()">
                <i class="bi bi-plus-lg"></i>
                <span>Добавить модуль</span>
            </button>
        </div>
    </div>

    {% if subfolders %}
    <div class="subfolders-section">
        <div class="section-header">
            <!-- Убран заголовок "Папки" -->
        </div>
        <div class="folders-grid">
            {% for subfolder in subfolders %}
            <div class="folder-item" onclick="window.location.href='{% url 'cards:folder' subfolder.id %}'">
                <div class="folder-header">
                    <div class="folder-icon">
                        <i class="bi bi-folder"></i>
                    </div>
                    <h3 class="folder-name">{{ subfolder.name }}</h3>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="modules-section">
        <div class="section-header">
            <!-- Убран заголовок "Модули" -->
        </div>
    <div class="modules-grid">
        {% for module in modules %}
            <div class="module-item" data-module-id="{{ module.id }}">
            <div class="module-header">
                <h3 class="module-title">{{ module.name }}</h3>
                <div class="module-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); removeModuleFromFolder({{ module.id }})">
                        <i class="bi bi-folder-minus"></i>
                    </button>
                </div>
            </div>
            <div class="meta-info">
                <span class="type-tag">{% if module.module_type == 'public' %}Открытый{% else %}Частный{% endif %}</span>
                {% if module.is_saved %}
                <span class="saved-tag"><i class="bi bi-bookmark-fill"></i></span>
                {% endif %}
            </div>
            <div class="module-author">
                <i class="bi bi-person"></i>
                    <span>Автор: {{ module.formatted_user }}</span>
            </div>
        </div>
        {% empty %}
            <!-- Убрано сообщение "В этой папке пока нет модулей" -->
        {% endfor %}
        </div>
    </div>
</div>

<!-- Модальное окно создания подпапки -->
<div class="modal" id="createFolderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Создать папку</h2>
            <button class="close-btn" onclick="closeModal('createFolderModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <form id="createFolderForm">
            <div class="form-group">
                <label for="folderName">Название папки</label>
                <input type="text" id="folderName" name="name" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeModal('createFolderModal')">Отмена</button>
                <button type="submit" class="submit-btn">Создать</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования папки -->
<div class="modal" id="editFolderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Редактировать папку</h2>
            <button class="close-btn" onclick="closeModal('editFolderModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <form id="editFolderForm">
            <input type="hidden" id="editFolderId" name="folderId">
            <div class="form-group">
                <label for="editFolderName">Название папки</label>
                <input type="text" id="editFolderName" name="name" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeModal('editFolderModal')">Отмена</button>
                <button type="submit" class="submit-btn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно добавления модуля -->
<div class="modal" id="addModuleModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить модуль</h2>
            <button class="close-btn" onclick="closeModal('addModuleModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('myModules')">Мои модули</button>
                <button class="tab-btn" onclick="switchTab('savedModules')">Сохраненные</button>
            </div>
            <div id="myModules" class="tab-content active">
                <div class="modules-list">
                    <!-- Мои модули будут добавлены здесь -->
                </div>
            </div>
            <div id="savedModules" class="tab-content">
                <div class="modules-list">
                    <!-- Сохраненные модули будут добавлены здесь -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления папки -->
<div class="modal" id="deleteFolderModal">
    <div class="modal-content delete-confirm">
        <div class="modal-header">
            <h2>Удалить папку</h2>
            <button class="close-btn" onclick="closeModal('deleteFolderModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-icon">
                <i class="bi bi-trash"></i>
            </div>
            <p>Вы уверены, что хотите удалить эту папку?</p>
            <p class="delete-warning">Это действие нельзя будет отменить.</p>
        </div>
        <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closeModal('deleteFolderModal')">Отмена</button>
            <button type="button" class="delete-btn" id="confirmDeleteFolderBtn">
                <i class="bi bi-trash"></i>
                <span>Удалить</span>
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления модуля -->
<div class="modal" id="deleteModuleModal">
    <div class="modal-content delete-confirm">
        <div class="modal-header">
            <h2>Удалить модуль</h2>
            <button class="close-btn" onclick="closeModal('deleteModuleModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-icon">
                <i class="bi bi-trash"></i>
            </div>
            <p>Вы уверены, что хотите удалить этот модуль?</p>
            <p class="delete-warning">Это действие нельзя будет отменить.</p>
        </div>
        <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closeModal('deleteModuleModal')">Отмена</button>
            <button type="button" class="delete-btn" id="confirmDeleteModuleBtn">
                <i class="bi bi-trash"></i>
                <span>Удалить</span>
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно ошибки удаления папки -->
<div class="modal" id="folderDeleteErrorModal">
    <div class="modal-content error-confirm">
        <div class="modal-header">
            <h2>Невозможно удалить папку</h2>
            <button class="close-btn" onclick="closeModal('folderDeleteErrorModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="error-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <p>Невозможно удалить папку, так как в ней содержатся модули.</p>
            <p>Пожалуйста, сначала удалите или переместите все модули из этой папки.</p>
        </div>
        <div class="modal-buttons">
            <button type="button" class="single-btn" onclick="closeModal('folderDeleteErrorModal')">Понятно</button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления модуля из папки -->
<div class="modal" id="removeModuleModal">
    <div class="modal-content delete-confirm">
        <div class="modal-header">
            <h2>Удалить модуль из папки</h2>
            <button class="close-btn" onclick="closeModal('removeModuleModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="remove-icon">
                <i class="bi bi-folder-minus"></i>
            </div>
            <p>Вы уверены, что хотите удалить этот модуль из текущей папки?</p>
            <p>Сам модуль останется в вашей библиотеке.</p>
        </div>
        <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closeModal('removeModuleModal')">Отмена</button>
            <button type="button" class="delete-btn" id="confirmRemoveModuleBtn">
                <i class="bi bi-folder-minus"></i>
                <span>Удалить из папки</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
.folder-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f8f5ff;
    min-height: 100vh;
    padding: 20px;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    padding: 15px;
    background: white;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    color: #666;
    text-decoration: none;
    padding: 5px 10px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.breadcrumb-item:hover {
    background: #e8e0ff;
    color: #7c4dff;
}

.breadcrumb-item.current {
    color: #7c4dff;
    font-weight: 500;
}

.breadcrumb-separator {
    color: #ccc;
    margin: 0 5px;
}

.breadcrumb-item i {
    margin-right: 6px;
}

.folder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.header-content {
    display: flex;
    align-items: center;
    gap: 20px;
}

.folder-header h1 {
    margin: 0;
    color: #333;
    font-size: 2rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-right: 10px;
}

.action-btn {
    background: #f0f0f0;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    opacity: 0.8;
    z-index: 10;
}

.action-btn:hover {
    background: #e0e0e0;
    opacity: 1;
    transform: translateY(-2px);
}

.action-btn i {
    font-size: 1.2rem;
}

.action-buttons .action-btn:first-child {
    color: #4a6bf5;
}

.action-buttons .action-btn:first-child:hover {
    background: #e8e0ff;
}

.action-buttons .action-btn:last-child {
    color: #f05151;
}

.action-buttons .action-btn:last-child:hover {
    background: #fff0f0;
}

.create-btn {
    background: white;
    border: 2px solid #7c4dff;
    color: #7c4dff;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.create-btn:hover {
    background: #7c4dff;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 77, 255, 0.2);
}

.section-header {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 20px;
}

.modules-section, .subfolders-section {
    margin-bottom: 30px;
}

.folder-header {
    margin-bottom: 20px;
}

.module-actions {
    display: flex;
    gap: 8px;
    position: absolute;
    top: 15px;
    right: 15px;
}

.module-actions .action-btn {
    width: 32px;
    height: 32px;
    color: #4a6bf5;
}

.module-actions .action-btn:hover {
    background: #e8e0ff;
}

.folders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.folder-item {
    background: white;
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.folder-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 77, 255, 0.1);
}

.folder-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 0;
    width: 100%;
}

.folder-icon {
    width: 40px;
    height: 40px;
    background: #f0e6ff;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #7c4dff;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.folder-name {
    font-size: 1.2rem;
    font-weight: 500;
    color: #333;
    margin: 0;
    word-break: break-word;
    overflow-wrap: break-word;
    padding: 8px 0;
}

.folder-item .folder-header {
    justify-content: flex-start;
}

.modules-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.module-item {
    background: white;
    border-radius: 16px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: relative;
}

.module-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 77, 255, 0.1);
}

.module-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.module-title {
    font-size: 1.1rem;
    font-weight: 500;
    color: #333;
    margin: 0;
}

.meta-info {
    display: flex;
    gap: 8px;
    align-items: center;
}

.type-tag {
    background: #e8e0ff;
    color: #7c4dff;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.875rem;
}

.saved-tag {
    color: #7c4dff;
    display: flex;
    align-items: center;
}

.module-author {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 0.9rem;
    margin-top: auto;
}

.module-author i {
    color: #7c4dff;
}

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px;
    color: #666;
    background: #f8f9fa;
    border-radius: 16px;
    border: 1px dashed #dee2e6;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.empty-state i {
    font-size: 3rem;
    color: #999;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 0;
    width: 90%;
    max-width: 600px;
    margin: 100px auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
}

.close-btn {
    background: none;
    border: none;
    color: #666;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background: #f0f0f0;
    color: #333;
}

.modal-body {
    padding: 24px;
}

.form-group {
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
}

.form-group:last-of-type {
    border-bottom: none;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #666;
    font-size: 0.9rem;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #7c4dff;
    box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
    outline: none;
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 10px 20px;
    border: none;
    background: none;
    color: #666;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: #7c4dff;
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.modules-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
}

.module-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.module-list-item:hover {
    background: #e8e0ff;
}

.module-list-item .module-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.module-list-item .module-name {
    font-weight: 500;
    color: #333;
}

.module-list-item .module-author {
    font-size: 0.875rem;
    color: #666;
}

.add-module-btn {
    background: #7c4dff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-module-btn:hover {
    background: #651fff;
}

.modal-buttons {
    padding: 20px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.cancel-btn,
.submit-btn {
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cancel-btn {
    background: #f0f0f0;
    border: none;
    color: #666;
}

.submit-btn {
    background: #7c4dff;
    border: none;
    color: white;
}

.cancel-btn:hover {
    background: #e0e0e0;
}

.submit-btn:hover {
    background: #651fff;
}

.delete-confirm {
    max-width: 400px;
}

.delete-confirm .modal-body {
    padding: 24px;
    text-align: center;
}

.delete-icon {
    font-size: 3rem;
    color: #ff4d4d;
    margin-bottom: 16px;
}

.delete-warning {
    color: #666;
    font-size: 0.9rem;
    margin-top: 8px;
}

.delete-btn {
    background: #ff4d4d;
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.delete-btn:hover {
    background: #ff3333;
    transform: translateY(-2px);
}

.delete-btn i {
    font-size: 1.1rem;
}

.error-confirm {
    max-width: 450px;
}

.error-confirm .modal-body {
    padding: 24px;
    text-align: center;
}

.error-icon {
    font-size: 3rem;
    color: #ff9900;
    margin-bottom: 16px;
}

.remove-icon {
    font-size: 3rem;
    color: #4a6bf5;
    margin-bottom: 16px;
}

.single-btn {
    background: #4a6bf5;
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.single-btn:hover {
    background: #3a58cc;
    transform: translateY(-2px);
}

/* Стили для уведомлений */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 2000;
    animation: notificationFadeIn 0.3s ease;
    max-width: 400px;
}

@keyframes notificationFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.notification.fade-out {
    animation: notificationFadeOut 0.3s ease forwards;
}

@keyframes notificationFadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

.notification-success {
    border-left: 4px solid #4caf50;
}

.notification-error {
    border-left: 4px solid #ff4d4d;
}

.notification-warning {
    border-left: 4px solid #ff9900;
}

.notification-icon {
    font-size: 1.5rem;
}

.notification-success .notification-icon {
    color: #4caf50;
}

.notification-error .notification-icon {
    color: #ff4d4d;
}

.notification-warning .notification-icon {
    color: #ff9900;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 500;
    margin: 0 0 4px 0;
}

.notification-message {
    color: #666;
    margin: 0;
    font-size: 0.9rem;
}

.notification-close {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 1.2rem;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.notification-close:hover {
    color: #333;
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .folders-grid, .modules-grid {
        grid-template-columns: 1fr;
    }
    
    .header-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .create-btn {
        padding: 10px 16px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Функции для работы с модальными окнами
function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Функция для создания уведомлений
function showNotification(type, title, message, duration = 5000) {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    // Иконка в зависимости от типа
    let icon = '';
    switch(type) {
        case 'success':
            icon = 'bi-check-circle';
            break;
        case 'error':
            icon = 'bi-x-circle';
            break;
        case 'warning':
            icon = 'bi-exclamation-triangle';
            break;
        default:
            icon = 'bi-info-circle';
    }
    
    // Формируем содержимое
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="bi ${icon}"></i>
        </div>
        <div class="notification-content">
            <h4 class="notification-title">${title}</h4>
            <p class="notification-message">${message}</p>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="bi bi-x"></i>
        </button>
    `;
    
    // Добавляем в body
    document.body.appendChild(notification);
    
    // Удаляем через указанное время
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, duration);
}

function showAddModuleModal() {
    loadMyModules();
    loadSavedModules();
    showModal('addModuleModal');
}

function showCreateFolderModal() {
    showModal('createFolderModal');
}

function switchTab(tabId) {
    // Скрываем все табы
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Показываем выбранный таб
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
}

// Функции для работы с папками
async function createFolder(e) {
    e.preventDefault();
    
    const folderName = document.getElementById('folderName').value;
    if (!folderName) return;
    
    try {
        const response = await fetch('/cards/api/create-folder/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                name: folderName,
                parent_id: {{ folder.id }}
            })
        });
        
        if (response.ok) {
            closeModal('createFolderModal');
            showNotification('success', 'Успешно', 'Папка успешно создана');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showNotification('error', 'Ошибка', data.error || 'Ошибка при создании папки');
        }
    } catch (error) {
        console.error('Error creating folder:', error);
        showNotification('error', 'Ошибка', 'Ошибка при создании папки');
    }
}

function editFolder(folderId, folderName) {
    document.getElementById('editFolderId').value = folderId;
    document.getElementById('editFolderName').value = folderName;
    showModal('editFolderModal');
}

async function updateFolder(e) {
    e.preventDefault();
    
    const folderId = document.getElementById('editFolderId').value;
    const folderName = document.getElementById('editFolderName').value;
    
    if (!folderName) return;
    
    try {
        const response = await fetch(`/cards/api/update-folder/${folderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                name: folderName
            })
        });
        
        if (response.ok) {
            closeModal('editFolderModal');
            showNotification('success', 'Успешно', 'Папка успешно обновлена');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showNotification('error', 'Ошибка', data.error || 'Ошибка при обновлении папки');
        }
    } catch (error) {
        console.error('Error updating folder:', error);
        showNotification('error', 'Ошибка', 'Ошибка при обновлении папки');
    }
}

function deleteFolder(folderId) {
    // Сохраняем ID папки и показываем модальное окно
    document.getElementById('confirmDeleteFolderBtn').setAttribute('data-folder-id', folderId);
    showModal('deleteFolderModal');
}

async function confirmDeleteFolder(folderId) {
    try {
        const response = await fetch(`/cards/api/delete-folder/${folderId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            closeModal('deleteFolderModal');
            showNotification('success', 'Успешно', 'Папка успешно удалена');
            // Перенаправляем на главную страницу карточек вместо перезагрузки
            setTimeout(() => {
                window.location.href = "{% url 'cards:cards' %}";
            }, 1000);
        } else {
            const data = await response.json();
            closeModal('deleteFolderModal');
            if (data.error && data.error.includes('содержит модули')) {
                showModal('folderDeleteErrorModal');
            } else {
                showNotification('error', 'Ошибка', data.error || 'Ошибка при удалении папки');
            }
        }
    } catch (error) {
        console.error('Error deleting folder:', error);
        showNotification('error', 'Ошибка', 'Ошибка при удалении папки');
    }
}

// Функция удаления модуля
function deleteModule(moduleId) {
    // Сохраняем ID модуля и показываем модальное окно
    document.getElementById('confirmDeleteModuleBtn').setAttribute('data-module-id', moduleId);
    showModal('deleteModuleModal');
}

async function confirmDeleteModule(moduleId) {
    try {
        const response = await fetch(`/cards/api/modules/${moduleId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            closeModal('deleteModuleModal');
            showNotification('success', 'Успешно', 'Модуль успешно удален');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showNotification('error', 'Ошибка', data.error || 'Ошибка при удалении модуля');
        }
    } catch (error) {
        console.error('Error deleting module:', error);
        showNotification('error', 'Ошибка', 'Ошибка при удалении модуля');
    }
}

// Функция для удаления модуля из папки
function removeModuleFromFolder(moduleId) {
    // Сохраняем ID модуля и показываем модальное окно
    document.getElementById('confirmRemoveModuleBtn').setAttribute('data-module-id', moduleId);
    showModal('removeModuleModal');
}

async function confirmRemoveModuleFromFolder(moduleId) {
    try {
        const response = await fetch(`/cards/api/modules/${moduleId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                folder_id: null
            })
        });
        
        if (response.ok) {
            closeModal('removeModuleModal');
            showNotification('success', 'Успешно', 'Модуль удален из папки');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showNotification('error', 'Ошибка', data.error || 'Ошибка при удалении модуля из папки');
        }
    } catch (error) {
        console.error('Error removing module from folder:', error);
        showNotification('error', 'Ошибка', 'Ошибка при удалении модуля из папки');
    }
}

// Функции для работы с модулями
async function loadMyModules() {
    try {
        const response = await fetch('/cards/api/modules/');
        const data = await response.json();
        
        if (data.modules) {
            const modulesList = document.querySelector('#myModules .modules-list');
            modulesList.innerHTML = '';
            
            data.modules.forEach(module => {
                const moduleElement = document.createElement('div');
                moduleElement.className = 'module-list-item';
                moduleElement.innerHTML = `
                    <div class="module-info">
                        <span class="module-name">${module.name}</span>
                        <span class="module-author">Автор: ${module.user}</span>
                    </div>
                    <button class="add-module-btn" onclick="addModuleToFolder(${module.id})">
                        Добавить
                    </button>
                `;
                modulesList.appendChild(moduleElement);
            });
        }
    } catch (error) {
        console.error('Error loading modules:', error);
        showNotification('error', 'Ошибка', 'Ошибка при загрузке модулей');
    }
}

async function loadSavedModules() {
    try {
        const response = await fetch('/cards/api/saved-modules/');
        const data = await response.json();
        
        if (data.modules) {
            const modulesList = document.querySelector('#savedModules .modules-list');
            modulesList.innerHTML = '';
            
            data.modules.forEach(module => {
                const moduleElement = document.createElement('div');
                moduleElement.className = 'module-list-item';
                moduleElement.innerHTML = `
                    <div class="module-info">
                        <span class="module-name">${module.name}</span>
                        <span class="module-author">Автор: ${module.user}</span>
                    </div>
                    <button class="add-module-btn" onclick="addModuleToFolder(${module.id})">
                        Добавить
                    </button>
                `;
                modulesList.appendChild(moduleElement);
            });
        }
    } catch (error) {
        console.error('Error loading saved modules:', error);
        showNotification('error', 'Ошибка', 'Ошибка при загрузке сохраненных модулей');
    }
}

async function addModuleToFolder(moduleId) {
    try {
        const response = await fetch(`/cards/api/modules/${moduleId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                folder_id: {{ folder.id }}
            })
        });
        
        if (response.ok) {
            closeModal('addModuleModal');
            showNotification('success', 'Успешно', 'Модуль добавлен в папку');
            setTimeout(() => {
            window.location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showNotification('error', 'Ошибка', data.error || 'Ошибка при добавлении модуля');
        }
    } catch (error) {
        console.error('Error adding module to folder:', error);
        showNotification('error', 'Ошибка', 'Ошибка при добавлении модуля');
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик формы создания папки
    document.getElementById('createFolderForm').addEventListener('submit', createFolder);
    
    // Обработчик формы редактирования папки
    document.getElementById('editFolderForm').addEventListener('submit', updateFolder);
    
    // Обработчик кнопки подтверждения удаления папки
    document.getElementById('confirmDeleteFolderBtn').addEventListener('click', function() {
        const folderId = this.getAttribute('data-folder-id');
        confirmDeleteFolder(folderId);
    });
    
    // Обработчик кнопки подтверждения удаления модуля
    document.getElementById('confirmDeleteModuleBtn').addEventListener('click', function() {
        const moduleId = this.getAttribute('data-module-id');
        confirmDeleteModule(moduleId);
    });
    
    // Обработчик кнопки подтверждения удаления модуля из папки
    document.getElementById('confirmRemoveModuleBtn').addEventListener('click', function() {
        const moduleId = this.getAttribute('data-module-id');
        confirmRemoveModuleFromFolder(moduleId);
    });

// Обработчик клика по модулю
document.querySelectorAll('.module-item').forEach(module => {
        module.addEventListener('click', function(event) {
            // Проверяем, что клик не был по кнопкам действий
            if (!event.target.closest('.action-btn')) {
                const moduleId = this.getAttribute('data-module-id');
                if (moduleId) {
        window.location.href = `/cards/module/${moduleId}/`;
                }
            }
        });
    });
});
</script>
{% endblock %} 