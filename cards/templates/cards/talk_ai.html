{% extends 'users/base.html' %}
{% load static %}

{% block title %}–ì–æ–≤–æ—Ä–∏—Ç—å —Å –ò–ò{% endblock %}
{% block head %}
{% block content %}
<!-- –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø –®–ê–ë–õ–û–ù–ê - 2025-10-06 -->
<div class="talk-ai-container">
    <div class="intro-section">
        <h1>–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –ò–ò</h1>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ò–ò.</p>
        <button class="start-fullscreen-btn" onclick="enterFullScreen()">
            <i class="bi bi-arrows-fullscreen"></i>
            <span>–ù–∞—á–∞—Ç—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º</span>
        </button>
    </div>
</div>

<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div class="full-screen-container" id="fullScreenContainer">
    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
    <button class="close-button" onclick="exitFullScreen()" title="–í—ã–π—Ç–∏">
        <i class="bi bi-x-lg"></i>
    </button>
    
    <!-- 3D –ê–≤–∞—Ç–∞—Ä -->
    <div class="ai-avatar-container" id="avatarContainer">
        <div class="model-loader" id="modelLoader">
            <div class="loader-spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ 3D –º–æ–¥–µ–ª–∏...</div>
        </div>
        <div class="avatar-placeholder" id="avatarPlaceholder" style="display: none;">
            <i class="bi bi-person-circle"></i>
        </div>
    </div>
    
    <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω -->
    <div class="microphone-container">
        <div class="recording-indicator" id="recordingIndicator">
            <div class="recording-dot"></div>
            <span class="recording-text">–ó–∞–ø–∏—Å—å...</span>
            <span class="timer" id="recordTimer">00:00</span>
        </div>
        <button class="mic-button" id="micButton" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏">
            <div class="mic-wave"></div>
            <div class="mic-wave" style="animation-delay: 0.7s;"></div>
            <i class="bi bi-mic-fill mic-icon" id="micIcon"></i>
        </button>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —á–∞—Ç–∞ -->
    <div class="chat-panel" id="chatPanel">
        <button class="chat-toggle" id="chatToggle" onclick="toggleChat()" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
            <i class="bi bi-chat-dots"></i>
        </button>
        
        <div class="chat-header">
            <h3 class="chat-title">–î–∏–∞–ª–æ–≥ —Å –ò–ò</h3>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <p class="message-content">–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π. –ù–∞—á–Ω–∏ –≥–æ–≤–æ—Ä–∏—Ç—å, –∏ —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å! üéØ</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.talk-ai-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    text-align: center;
}

.intro-section h1 {
    font-size: 2.5rem;
    color: #667eea;
    margin-bottom: 1rem;
}

.intro-section p {
    font-size: 1.2rem;
    color: #666;
    margin-bottom: 2rem;
}

.start-fullscreen-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.start-fullscreen-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.full-screen-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
    z-index: 10000;
    display: none;
}

.full-screen-container.active {
    display: block;
}

/* 3D –º–æ–¥–µ–ª—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - —Ç–æ–ª—å–∫–æ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ */
.full-screen-container .ai-avatar-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 600px;
    z-index: 1001;
}

.full-screen-container .avatar-placeholder {
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.full-screen-container .avatar-placeholder:hover {
    transform: scale(1.05);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
}

.full-screen-container .avatar-placeholder i {
    font-size: 8rem;
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤ —Ü–µ–Ω—Ç—Ä–µ —Å–Ω–∏–∑—É */
.microphone-container {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1003;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.mic-button {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.mic-button:hover {
    transform: scale(1.1);
    box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
}

.mic-button.recording {
    animation: record-pulse 1.5s ease-in-out infinite;
    background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
}

@keyframes record-pulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
    }
    50% {
        transform: scale(1.15);
        box-shadow: 0 20px 50px rgba(255, 107, 107, 0.8);
    }
}

.mic-icon {
    font-size: 3rem;
    color: white;
    z-index: 1;
}

/* –í–æ–ª–Ω—ã –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ */
.mic-wave {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    opacity: 0;
    animation: wave-expand 2s ease-out infinite;
}

.mic-button.recording .mic-wave {
    opacity: 1;
}

@keyframes wave-expand {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.7;
    }
    100% {
        transform: translate(-50%, -50%) scale(3);
        opacity: 0;
    }
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
.recording-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.recording-indicator.active {
    opacity: 1;
}

.recording-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ff4757;
    animation: blink 1s ease-in-out infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.recording-text {
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.timer {
    color: white;
    font-size: 1rem;
    font-weight: 500;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* –ü–∞–Ω–µ–ª—å —á–∞—Ç–∞ —Å–ø—Ä–∞–≤–∞ */
.chat-panel {
    position: absolute;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    transition: right 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 1002;
    display: flex;
    flex-direction: column;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
}

.chat-panel.open {
    right: 0;
}

.chat-header {
    padding: 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.8);
}

.chat-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
}

.chat-toggle {
    position: absolute;
    left: -50px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 60px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 10px 0 0 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.chat-toggle:hover {
    background: white;
    box-shadow: -10px 0 20px rgba(0, 0, 0, 0.15);
}

.chat-toggle i {
    font-size: 1.2rem;
    color: #667eea;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message {
    padding: 12px 16px;
    border-radius: 16px;
    max-width: 85%;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message.ai {
    align-self: flex-start;
    background: #f8f9fa;
    color: #2c3e50;
    border: 1px solid #e9ecef;
}

.message.error {
    align-self: flex-start;
    background: #ffe6e6;
    color: #d63031;
    border: 1px solid #ffc4c4;
}

.message-content {
    margin: 0;
    line-height: 1.4;
}

.message-time {
    font-size: 0.8rem;
    opacity: 0.7;
    margin-top: 5px;
}

/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
.close-button {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    z-index: 1004;
}

.close-button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.close-button i {
    font-size: 1.2rem;
    color: white;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .ai-avatar-container {
        width: 300px;
        height: 450px;
    }
    
    .mic-button {
        width: 100px;
        height: 100px;
    }
    
    .mic-icon {
        font-size: 2.5rem;
    }
    
    .chat-panel {
        width: 100vw;
        right: -100vw;
    }
    
    .chat-toggle {
        display: none;
    }
}

/* Loader –¥–ª—è 3D –º–æ–¥–µ–ª–∏ */
.model-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 1.2rem;
    text-align: center;
}

.loader-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- Three.js –¥–ª—è 3D –º–æ–¥–µ–ª–∏ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let scene, camera, renderer, avatar;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let recordingTimer = null;
let recordingStartTime = 0;
let speechRecognition = null;
let isChatOpen = false;
let currentAudio = null;

// –í—Ö–æ–¥ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
function enterFullScreen() {
    const fullScreenContainer = document.getElementById('fullScreenContainer');
    fullScreenContainer.classList.add('active');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
    init3DAvatar();
    initSpeechRecognition();
    setupEventListeners();
}

// –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
function exitFullScreen() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –æ–Ω–∞ –∏–¥–µ—Ç
    if (isRecording) {
        stopRecording();
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const fullScreenContainer = document.getElementById('fullScreenContainer');
    fullScreenContainer.classList.remove('active');
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 3D –∞–≤–∞—Ç–∞—Ä–∞
function init3DAvatar() {
    const container = document.getElementById('avatarContainer');
    const loader = document.getElementById('modelLoader');
    const placeholder = document.getElementById('avatarPlaceholder');
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setClearColor(0x000000, 0); // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // –û—Å–≤–µ—â–µ–Ω–∏–µ
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 10, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    // –ü–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã
    camera.position.z = 3;
    camera.position.y = 1;
    
    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ç–æ–≤—É—é 3D –º–æ–¥–µ–ª—å —á–µ–ª–æ–≤–µ–∫–∞
    // –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∑–∞–º–µ–Ω—è—é—â—É—é –º–æ–¥–µ–ª—å
    createFallbackAvatar();
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä –≤ DOM
    loader.style.display = 'none';
    container.appendChild(renderer.domElement);
    
    // –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª
    animate();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥–µ–ª–∏ –∞–≤–∞—Ç–∞—Ä–∞ (fallback)
function createFallbackAvatar() {
    const group = new THREE.Group();
    
    // –ì–æ–ª–æ–≤–∞
    const headGeometry = new THREE.SphereGeometry(0.3, 32, 32);
    const headMaterial = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
    const head = new THREE.Mesh(headGeometry, headMaterial);
    head.position.y = 1.5;
    head.castShadow = true;
    group.add(head);
    
    // –¢–µ–ª–æ
    const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.4, 1.2, 8);
    const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x4a90e2 });
    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
    body.position.y = 0.4;
    body.castShadow = true;
    group.add(body);
    
    // –†—É–∫–∏
    const armGeometry = new THREE.CylinderGeometry(0.05, 0.08, 0.8, 8);
    const armMaterial = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
    
    const leftArm = new THREE.Mesh(armGeometry, armMaterial);
    leftArm.position.set(-0.5, 0.6, 0);
    leftArm.rotation.z = Math.PI / 6;
    leftArm.castShadow = true;
    group.add(leftArm);
    
    const rightArm = new THREE.Mesh(armGeometry, armMaterial);
    rightArm.position.set(0.5, 0.6, 0);
    rightArm.rotation.z = -Math.PI / 6;
    rightArm.castShadow = true;
    group.add(rightArm);
    
    // –ì–ª–∞–∑–∞
    const eyeGeometry = new THREE.SphereGeometry(0.05, 16, 16);
    const eyeMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
    
    const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
    leftEye.position.set(-0.1, 1.6, 0.25);
    group.add(leftEye);
    
    const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
    rightEye.position.set(0.1, 1.6, 0.25);
    group.add(rightEye);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ —Å—Ü–µ–Ω—É
    avatar = group;
    scene.add(avatar);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é –∞–Ω–∏–º–∞—Ü–∏—é –¥—ã—Ö–∞–Ω–∏—è
    avatar.userData = { 
        originalScale: avatar.scale.clone(),
        breathingTime: 0
    };
}

// –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª
function animate() {
    requestAnimationFrame(animate);
    
    if (avatar) {
        // –ê–Ω–∏–º–∞—Ü–∏—è –¥—ã—Ö–∞–Ω–∏—è
        avatar.userData.breathingTime += 0.01;
        const breathingScale = 1 + Math.sin(avatar.userData.breathingTime) * 0.02;
        avatar.scale.y = avatar.userData.originalScale.y * breathingScale;
        
        // –õ–µ–≥–∫–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ
        avatar.rotation.y = Math.sin(avatar.userData.breathingTime * 0.5) * 0.1;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ò–ò
        if (currentAudio && !currentAudio.paused) {
            const talkingScale = 1 + Math.sin(Date.now() * 0.02) * 0.05;
            avatar.children[0].scale.setScalar(talkingScale); // –ì–æ–ª–æ–≤–∞
        } else if (avatar.children[0]) {
            avatar.children[0].scale.setScalar(1);
        }
    }
    
    renderer.render(scene, camera);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        
        speechRecognition.continuous = true;
        speechRecognition.interimResults = true;
        speechRecognition.lang = 'en-US';
        
        speechRecognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            
            if (finalTranscript) {
                sendMessageToAI(finalTranscript.trim());
            }
        };
        
        speechRecognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            addMessage('error', `–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: ${event.error}`);
        };
        
        speechRecognition.onend = () => {
            stopRecording();
        };
    } else {
        console.warn('Speech recognition not supported');
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventListeners() {
    const micButton = document.getElementById('micButton');
    const chatToggle = document.getElementById('chatToggle');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    micButton.addEventListener('click', toggleRecording);
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', onWindowResize);
    
    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
    document.addEventListener('keydown', (event) => {
        if (event.code === 'Space' && event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
            event.preventDefault();
            toggleRecording();
        }
        if (event.key === 'Escape') {
            if (isChatOpen) {
                toggleChat();
            } else {
                exitFullScreen();
            }
        }
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

// –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
function startRecording() {
    if (!speechRecognition) {
        addMessage('error', '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        return;
    }
    
    isRecording = true;
    recordingStartTime = Date.now();
    
    // –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    const micButton = document.getElementById('micButton');
    const micIcon = document.getElementById('micIcon');
    const recordingIndicator = document.getElementById('recordingIndicator');
    
    micButton.classList.add('recording');
    micIcon.classList.remove('bi-mic-fill');
    micIcon.classList.add('bi-mic-mute-fill');
    recordingIndicator.classList.add('active');
    
    // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
    updateRecordingTimer();
    recordingTimer = setInterval(updateRecordingTimer, 1000);
    
    // –ó–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    try {
        speechRecognition.start();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
        stopRecording();
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É
    setTimeout(() => {
        if (isRecording) {
            stopRecording();
        }
    }, 60000);
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
function stopRecording() {
    if (!isRecording) return;
    
    isRecording = false;
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    if (speechRecognition) {
        try {
            speechRecognition.stop();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
        }
    }
    
    // –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    const micButton = document.getElementById('micButton');
    const micIcon = document.getElementById('micIcon');
    const recordingIndicator = document.getElementById('recordingIndicator');
    
    micButton.classList.remove('recording');
    micIcon.classList.remove('bi-mic-mute-fill');
    micIcon.classList.add('bi-mic-fill');
    recordingIndicator.classList.remove('active');
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞
    document.getElementById('recordTimer').textContent = '00:00';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∑–∞–ø–∏—Å–∏
function updateRecordingTimer() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('recordTimer').textContent = timerText;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò
async function sendMessageToAI(text) {
    if (!text || !text.trim()) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage('user', text);
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —á–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞
    if (!isChatOpen) {
        toggleChat();
    }
    
    try {
        const response = await fetch('{% url "cards:api_chat_ai" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: text })
        });
        
        const data = await response.json();
        
        if (data.error) {
            addMessage('error', data.error);
            return;
        }
        
        const reply = data.reply || '–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞';
        addMessage('ai', reply);
        
        // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ò–ò
        await playTTS(reply);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        addMessage('error', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(type, content) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const contentP = document.createElement('p');
    contentP.className = 'message-content';
    contentP.textContent = content;
    messageDiv.appendChild(contentP);
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date().toLocaleTimeString();
    messageDiv.appendChild(timeDiv);
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞
function toggleChat() {
    const chatPanel = document.getElementById('chatPanel');
    const chatToggle = document.getElementById('chatToggle');
    const chatIcon = chatToggle.querySelector('i');
    
    isChatOpen = !isChatOpen;
    chatPanel.classList.toggle('open', isChatOpen);
    
    if (isChatOpen) {
        chatIcon.classList.remove('bi-chat-dots');
        chatIcon.classList.add('bi-x-lg');
        chatToggle.title = '–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç';
    } else {
        chatIcon.classList.remove('bi-x-lg');
        chatIcon.classList.add('bi-chat-dots');
        chatToggle.title = '–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç';
    }
}

// –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
function clearChat() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
        <div class="message ai">
            <p class="message-content">–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π. –ù–∞—á–Ω–∏ –≥–æ–≤–æ—Ä–∏—Ç—å, –∏ —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å! üéØ</p>
        </div>
    `;
}

// –û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ TTS
async function playTTS(text) {
    try {
        const response = await fetch('{% url "cards:api_tts" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ text })
        });
        
        const data = await response.json();
        
        if (data.url) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∞—É–¥–∏–æ
            if (currentAudio) {
                currentAudio.pause();
            }
            
            currentAudio = new Audio(data.url);
            currentAudio.play();
            
            currentAudio.onended = () => {
                currentAudio = null;
            };
        } else {
            // Fallback –Ω–∞ Web Speech API
            fallbackTTS(text);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ TTS:', error);
        fallbackTTS(text);
    }
}

// Fallback TTS —á–µ—Ä–µ–∑ Web Speech API
function fallbackTTS(text) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => 
            voice.lang.includes('en') && voice.name.includes('Google')
        ) || voices.find(voice => voice.lang.includes('en'));
        
        if (preferredVoice) {
            utterance.voice = preferredVoice;
        }
        
        speechSynthesis.speak(utterance);
    }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
function onWindowResize() {
    if (renderer && camera) {
        const container = document.getElementById('avatarContainer');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}