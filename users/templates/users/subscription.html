{% extends 'users/base.html' %}
{% load static %}

{% block title %}–ú–æ—è –ø–æ–¥–ø–∏—Å–∫–∞{% endblock %}

{% block extra_css %}
<style>
.subscription-page{background:linear-gradient(135deg,#f6f3ff 0%,#eef6ff 55%,#e8fff7 100%);padding:24px 0}
.subscription-container{max-width:1200px;margin:0 auto;padding:0 20px}

.hero{position:relative;border-radius:16px;padding:28px 24px;background:linear-gradient(135deg,#7c4dff,#5b8dff);color:#fff;box-shadow:0 10px 30px rgba(124,77,255,.35);overflow:hidden}
.hero:after{content:'';position:absolute;right:-60px;top:-60px;width:220px;height:220px;background:radial-gradient(closest-side,rgba(255,255,255,.28),rgba(255,255,255,0));border-radius:50%}
.hero-title{display:flex;align-items:center;gap:12px;font-size:22px;font-weight:700;margin:0 0 6px 0}
.hero-sub{opacity:.95}
.status{display:flex;gap:14px;align-items:center;margin-top:12px}
.status-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.28);padding:8px 12px;border-radius:999px}
.status small{opacity:.9}

.panel{margin-top:18px;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);border:1px solid #eef;box-shadow:0 8px 22px rgba(46,60,100,.12);border-radius:14px;padding:16px}
.promo{display:flex;gap:10px;align-items:center}
.promo input{flex:1;border:1.5px solid #d9def5;border-radius:12px;padding:12px 14px;outline:none;transition:.2s;background:#fff}
.promo input:focus{box-shadow:0 0 0 4px rgba(124,77,255,.12);border-color:#7c4dff}
.btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer}
.btn-apply{background:#111827;color:#fff}
.promo-msg{margin-top:8px;font-weight:600}
.promo-msg.success{color:#059669}
.promo-msg.error{color:#ef4444}

.plans{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
.plan{position:relative;background:#fff;border:1px solid #eef;border-radius:16px;box-shadow:0 12px 24px rgba(20,24,40,.08);padding:20px;display:flex;flex-direction:column;transition:transform .2s, box-shadow .2s}
.plan:hover{transform:translateY(-4px);box-shadow:0 16px 32px rgba(20,24,40,.12)}
.badge{position:absolute;top:14px;right:14px;background:#111827;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
.badge.upgrade{background:#059669}
.badge.current{background:#7c4dff}
.plan h3{margin:0 0 8px 0;font-size:20px}
.plan .desc{color:#6b7280;margin-bottom:10px}
.price{display:flex;align-items:flex-end;gap:10px;margin:10px 0 12px 0}
.price .old{color:#9ca3af;text-decoration:line-through}
.price .new{font-size:28px;font-weight:800;color:#111827}
.per{color:#6b7280}
.features{display:flex;flex-direction:column;gap:8px;margin:12px 0 16px 0}
.feature{display:flex;gap:10px;align-items:flex-start;color:#374151}
.feature i{color:#10b981;margin-top:2px}
.buy{margin-top:auto}
.btn-primary{background:#7c4dff;color:#fff;border:none;border-radius:12px;padding:12px 14px;cursor:pointer;width:100%;font-weight:700}
.btn-primary:hover{filter:brightness(.95)}

@media(max-width:1100px){.plans{grid-template-columns:1fr}}
</style>
{% endblock %}

{% block content %}
<div class="subscription-page">
  <div class="subscription-container">
    <div class="hero">
      <div class="hero-title"><i class="bi bi-star-fill"></i> –ú–æ—è –ø–æ–¥–ø–∏—Å–∫–∞</div>
      <div class="hero-sub">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏.</div>
      <div class="status">
        <div class="status-pill"><i class="bi bi-shield-check"></i> –¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω: <strong>{{ subscription.get_subscription_type_display }}</strong>{% if subscription.is_active %} ‚Ä¢ –∞–∫—Ç–∏–≤–Ω–∞{% else %} ‚Ä¢ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞{% endif %}</div>
        {% if subscription.end_date %}<small>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {{ subscription.end_date|date:'d.m.Y H:i' }}</small>{% endif %}
      </div>
    </div>

    <div class="panel">
      <div class="promo">
        <input id="promoInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ENG10)">
        <button id="applyPromo" class="btn btn-apply"><i class="bi bi-ticket-perforated"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div id="promoMessage" class="promo-msg"></div>
    </div>

    <div class="plans">
      {% for code, plan in subscription_plans.items %}
      <div class="plan{% if code == 'pro' %} featured{% endif %}" data-code="{{ code }}" data-price="{{ plan.price }}">
        {% if has_active_subscription %}<div class="badge upgrade">–ê–ø–≥—Ä–µ–π–¥ -50%</div>{% endif %}
        {% if subscription.subscription_type == code %}<div class="badge current">–¢–µ–∫—É—â–∏–π</div>{% endif %}
        <h3>{{ plan.name }}</h3>
        <div class="desc">{{ plan.description }}</div>
        <div class="price">
          {% if has_active_subscription %}
            <div class="old"><span class="val">{{ plan.price }}</span> ‚ÇΩ</div>
            <div class="new"><span class="val-discount">{{ plan.price }}</span> ‚ÇΩ</div>
            <div class="per">/ 30 –¥–Ω–µ–π</div>
          {% else %}
            <div class="new"><span class="val">{{ plan.price }}</span> ‚ÇΩ</div>
            <div class="per">/ 30 –¥–Ω–µ–π</div>
          {% endif %}
        </div>
        <div class="features">
          {% for f in plan.features %}
          <div class="feature"><i class="bi bi-check2-circle"></i><div>{{ f }}</div></div>
          {% endfor %}
        </div>
        <div class="buy"><button class="btn-primary buy-btn" {% if subscription.subscription_type == code and subscription.is_active %}disabled{% endif %}>{% if subscription.subscription_type == code and subscription.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ö—É–ø–∏—Ç—å{% endif %}</button></div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function(){
  const csrf = (name=>{let v=null;if(document.cookie&&document.cookie!==''){const a=document.cookie.split(';');for(let i=0;i<a.length;i++){const c=a[i].trim();if(c.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(c.substring(name.length+1));break;}}}return v;})('csrftoken');
  const promoInput = document.getElementById('promoInput');
  const promoBtn = document.getElementById('applyPromo');
  const promoMsg = document.getElementById('promoMessage');
  
  let currentPromo = null;
  
  // –ü–æ–∫–∞–∑ —Ü–µ–Ω—ã –∞–ø–≥—Ä–µ–π–¥–∞ (-50%) –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
  const hasUpgrade = {{ has_active_subscription|yesno:'true,false' }};
  if(hasUpgrade){
    document.querySelectorAll('.plan').forEach(card=>{
      const price = parseFloat(card.getAttribute('data-price')||'0');
      const newVal = Math.max(0, price * 0.5).toFixed(0);
      const node = card.querySelector('.val-discount');
      if(node){ node.textContent = newVal; }
    });
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
  function updatePrices(discountPercent = 0) {
    document.querySelectorAll('.plan').forEach(card => {
      const basePrice = parseFloat(card.getAttribute('data-price') || '0');
      const upgradeDiscount = hasUpgrade ? 0.5 : 0;
      const promoDiscount = discountPercent / 100;
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –∞–ø–≥—Ä–µ–π–¥, –ø–æ—Ç–æ–º –ø—Ä–æ–º–æ–∫–æ–¥
      let finalPrice = basePrice * (1 - upgradeDiscount);
      finalPrice = finalPrice * (1 - promoDiscount);
      finalPrice = Math.max(0, finalPrice);
      
      const oldPriceNode = card.querySelector('.old .val');
      const newPriceNode = card.querySelector('.new .val, .new .val-discount');
      const perNode = card.querySelector('.per');
      
      if (newPriceNode) {
        if (finalPrice === 0) {
          newPriceNode.textContent = '–ë–ï–°–ü–õ–ê–¢–ù–û';
          newPriceNode.style.color = '#10b981';
          newPriceNode.style.fontWeight = '800';
          if (perNode) perNode.style.display = 'none';
        } else {
          newPriceNode.textContent = finalPrice.toFixed(0);
          newPriceNode.style.color = '';
          newPriceNode.style.fontWeight = '';
          if (perNode) perNode.style.display = '';
        }
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∞
      if (oldPriceNode && (upgradeDiscount > 0 || promoDiscount > 0)) {
        oldPriceNode.textContent = basePrice.toFixed(0);
        oldPriceNode.parentElement.style.display = '';
      }
    });
  }

  promoBtn.addEventListener('click', async ()=>{
    const code = (promoInput.value||'').trim();
    if(!code){ promoMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'; promoMsg.className='promo-msg error'; return; }
    
    const resp = await fetch('{% url "validate_promo_code" %}',{method:'POST',headers:{'X-CSRFToken':csrf},body:new URLSearchParams({promo_code:code})});
    const data = await resp.json();
    
    promoMsg.textContent = data.message || '';
    promoMsg.className = 'promo-msg ' + (data.success ? 'success' : 'error');
    
    if (data.success) {
      currentPromo = { code: code, discount: data.discount_percent };
      updatePrices(data.discount_percent);
      
      // –ï—Å–ª–∏ —Å–∫–∏–¥–∫–∞ 100%, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º Pro –≤–µ—Ä—Å–∏—é
      if (data.discount_percent >= 100) {
        setTimeout(async () => {
          const form = new URLSearchParams({subscription_type: 'pro', promo_code: code});
          const resp = await fetch('{% url "create_payment" %}',{method:'POST',headers:{'X-CSRFToken':csrf},body:form});
          const result = await resp.json();
          if (result.success) {
            alert('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! Pro –≤–µ—Ä—Å–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ë–ï–°–ü–õ–ê–¢–ù–û!');
            window.location.reload();
          }
        }, 1000);
      }
    } else {
      currentPromo = null;
      updatePrices(0);
    }
  });

  document.querySelectorAll('.buy-btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const card = e.target.closest('.plan');
      const code = card.getAttribute('data-code');
      const promo = currentPromo ? currentPromo.code : (promoInput.value||'').trim();
      const form = new URLSearchParams({subscription_type:code});
      if(promo) form.append('promo_code', promo);
      const resp = await fetch('{% url "create_payment" %}',{method:'POST',headers:{'X-CSRFToken':csrf},body:form});
      const data = await resp.json();
      if(data.success){
        const amount = data.amount;
        const message = amount === 0 ? 
          'üéâ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ë–ï–°–ü–õ–ê–¢–ù–û! –¢–∞—Ä–∏—Ñ: ' + (data.subscription_type||code) :
          '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –¢–∞—Ä–∏—Ñ: '+ (data.subscription_type||code) +'. –°—É–º–º–∞: '+ amount + ' ‚ÇΩ';
        alert(message);
        window.location.reload();
      }else{
        alert(data.message||'–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è');
      }
    });
  });
})();
</script>
{% endblock %}


